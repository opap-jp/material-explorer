# 3. ファイルキャッシュの ID としてパスでなくハッシュ値を使用する

日付: 2018-05-01

## 状態

Accepted

## 前提

このアプリケーションでは、リポジトリの更新処理の過程で取得したファイルのデータは、次回以降の更新処理を高速にするために、データをキャッシュします。

これまでは、ファイルのパスの構造に従って、ファイルシステムにファイルを保存していました。
パスは、キャッシュの事実上の ID といえます。
更新処理においてファイルが要求され、そのファイルに対応するそれらしい「キャッシュ」が存在していても、ファイルが現在のリビジョンにおいて前回のリビジョンから変化していないことを確かめなければなりませんでした。

そのため、これまでは、更新処理の最初に、前回のリビジョンから現在のリビジョンまでに**変化した**ファイルのリストを取得し、そのリストに含まれるファイルに該当する「キャッシュ」を削除していました。
変化したファイルの「キャッシュ」が削除されることで、変化したファイルが要求されたときにはキャッシュミスが発生し、結果として最新のファイルが正しく取得されます。

しかし、変化したファイルのリストを取得する機能はすべての Git リポジトリクライアントに実装されているわけではありません。
更新処理の流れやインターフェイスは特定の Git リポジトリクライアント（GitLab API です。）に依存し、そのデザインはそれに大きく影響された、複雑なものになっていました。

## 決定

ファイルのキャッシュの ID として、パスではなく Git オブジェクトのハッシュ値を使用します。
キャッシュは、ファイルシステムでなくデータベースに保存します。

Git リポジトリで管理されているファイルの Git オブジェクトのハッシュ値は、すべての標準的な Git リポジトリクライアントで取得できます。

Git オブジェクトのハッシュ値は、データの内容によって決定されます。
そのため、内容が同じであれば、ファイル名が異なっていても同じ値になります。

## 影響

- ファイルのキャッシュの ID としてハッシュ値を使用することで、ファイルが変化していれば自動的にキャッシュミスが発生します。
- 更新処理の流れやインターフェイスは汎用的で単純なデザインになるでしょう。
- ファイルをファイルシステムではなくデータベースに保存することで、プログラムはより単純になるでしょう。
- 更新処理において無効な「キャッシュ」を削除する機能を追加的に実装しない限り、データベースには無効な「キャッシュ」が削除されないまま残り、運用の時間に応じて「キャッシュ」の容量が肥大します。
  そのため、そのような機能を実装するのが望ましいでしょう。
