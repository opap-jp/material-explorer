# タグ

## 概要

**タグ**（*tag*）は、簡潔な自然言語で記述される、**素材**（*material*）の特徴を説明する属性の一つです。タグは特徴による素材の検索を実現します。

一つの素材には0個以上のタグが設定され、一つのタグは0個以上の素材に設定されます。

**素材の検索者**は、検索においてタグを使用することができます。
検索条件としてタグを指定することで、そのタグが設定された素材のリストを取得できます。

タグの例としては、`井二 かける`，`こうしす！第1話`，`祝園 アカネ` などがあります。

## 素材に対するタグの設定

タグは、あらかじめ**マニフェスト**（*manifest*）において宣言されなければなりません。
マニフェストで宣言されたタグは**宣言済みタグ**（*declared tag*）として**タグ定義**（*tag definitions*）に追加されます。
タグ定義は、システム全体に存在するタグの集合です。

素材に対してタグを設定するには、その素材に対応する**メタデータファイル**（*metadata file*）において記述される**メタデータ**（*metadata*）で、そのタグの名称（後述）を記述します。

素材に対して宣言されていないタグの設定が試みられると、そのタグは特殊なタグ，**未宣言タグ**（*undeclared tag*）としてタグ定義に追加され、未宣言タグが存在していることを示す警告が登録されます。

## 形式

タグを構成する、自然言語による記述をタグの**名称**（*name*）といいます。
また、複数の古い名称を別の名称で上書きして総称するために用いる特殊な名称を、**総称置換子**（*generic replacement*）といいます。

タグは、0個以上の名称を持ち、たかだか1個の総称置換子を持ちます。
また、名称と総称置換子の合計は最低でも1でなければなりません。

タグの例としては、名称として `[祝園 アカネ, アカネ]` を持つものなどがあります。

### 種別とグループ

タグの**種別**（*kind*）は、そのタグがどのように定義・設定されるかを示すものです。
種別はアプリケーションで完全に定義されており、**素材の登録者**が追加することはできません。3個の種別があります。

|名称                  |一意  |グループ名|説明                                                                          |
|:---------------------|:-----|:---------|:-----------------------------------------------------------------------------|
|普通（`common`）      |いいえ|必要      |マニフェストで定義され、メタデータで設定されるタグ。                          |
|作成者（`author`）    |はい  |不要      |マニフェストで定義され、メタデータで設定されたり自動的に設定されたりするタグ。|
|未宣言（`undeclared`）|はい  |不要      |マニフェストで定義されていないタグの設定が試みられたときに定義されるタグ。    |

タグの**グループ**（*group*）は、グループ化されたタグのリストです。素材の登録者は、意味に応じてタグをグループ化して宣言しなければなりません。

一つのグループは、一つの種別を持ちます。一つの種別には0個以上のグループが属します。
ただし、**一意**（*unique*）であるカテゴリは、属するグループがたかだか1個でなければなりません。
種別が「普通」のグループには名前が必要です。
種別が「未宣言」のグループを宣言することはできません。

一つのタグは、一つのグループに属します。一つのグループには0個以上のタグが属します。
したがって、一つのタグは一つの種別に属します。

グループの例としては、`作成者`，`リポジトリ`，`人物` などがあります。

### 正規化

タグの名称は、3つの領域で記述されます。

1. マニフェストのタグ定義
2. 素材のメタデータ
3. 素材の検索者によって入力される検索クエリ―

タグ定義での名称に対する多少の表記の**揺れ**を許容するため、タグは**正規化**（*normalize*）されます。
正規化は、実際には次のことが行なわれます。

1. 半角スペースと全角スペースが削除されます。
1. 全角英数は半角英数に変換されます。
1. カタカナはひらがなに変換されます。
1. 大文字は小文字に変換されます。

たとえば、`祝園 アカネ` は `祝園あかね` に変換されます。

効率的な検索のために、正規化された文字列は保存される必要があります。
また、アプリケーションでタグ定義での表記を表示するために、タグ定義での正規化される前の名称も保存される必要があります。
そのため、正規化される前の名称と正規化された文字列の両方が保存されることになります。

未宣言タグのタグ定義での表記は、メタデータで設定された文字列をタグの名称として正規化したものと同じになります。

## タグの一致

メタデータで設定された文字列をタグの名称として正規化したものが、タグ定義に存在するタグの名称のそれぞれを正規化したもののどれかに一致するとき、タグが一致したとみなされ、メタデータとタグ定義のタグが関連づけられます。

検索クエリ―でタグとして指定された文字列をタグの名称として正規化したものが、タグ定義に存在するタグの名称のそれぞれを正規化したもののどれかに一致するとき、タグが一致したとみなされ、そのタグ定義と関連づけられたメタデータが設定された素材を取得します。

メタデータで設定された文字列や検索クエリ―でタグとして指定された文字列は、たかだか1個のタグにしか一致しません。
